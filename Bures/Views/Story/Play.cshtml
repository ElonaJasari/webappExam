@model Bures.ViewModels.StoryPlayViewModel

@{
    ViewData["Title"] = Model.DisplayTitle;
    Layout = null;
}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"]</title>
    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="~/css/site.css" />
</head>
<body style="margin: 0; padding: 0; overflow: hidden;">

<div class="visual-novel-container">
    @* Preload current scene and character images to reduce perceived latency *@
    @if (!string.IsNullOrEmpty(Model.CurrentAct.ImageUrl))
    {
        <link rel="preload" as="image" href="@Model.CurrentAct.ImageUrl" />
    }
    @if (Model.CurrentAct.Character != null && !string.IsNullOrEmpty(Model.CurrentAct.Character.ImageUrl))
    {
        <link rel="preload" as="image" href="@Model.CurrentAct.Character.ImageUrl" />
    }
    @* Background Image *@
    @if (!string.IsNullOrEmpty(Model.CurrentAct.ImageUrl))
    {
        <div class="scene-background">
            <img src="@Model.CurrentAct.ImageUrl" alt="Scene" loading="eager" />
        </div>
    }

    <div class="game-ui">
        @* Top Status Bar *@
        <div class="top-bar">
            <div>
                <strong>@Model.DisplayTitle</strong>
                @if (!string.IsNullOrEmpty(Model.SelectedCharacterName))
                {
                    <span class="ms-3">Playing as: @Model.SelectedCharacterName</span>
                }
            </div>
            <div>
                <span class="ms-3">Trust: @Model.Trust</span>
            </div>
        </div>

        @* NPC Character Sprite with fallback *@
        @if (Model.CurrentAct.Character != null)
        {
            var npcImage = Model.CurrentAct.Character.ImageUrl;
            if (string.IsNullOrEmpty(npcImage))
            {
                // Fallbacks by known character names
                var name = Model.CurrentAct.Character.Name ?? string.Empty;
                if (name.Contains("Teach", StringComparison.OrdinalIgnoreCase))
                {
                    npcImage = "/images/teacher.png";
                }
                else if (name.Contains("Mother", StringComparison.OrdinalIgnoreCase) || name.Contains("Parent", StringComparison.OrdinalIgnoreCase))
                {
                    npcImage = "/images/mom_character.png";
                }
                else if (name.Contains("Áilu", StringComparison.OrdinalIgnoreCase))
                {
                    npcImage = "/images/Friend_1.png";
                }
                else if (name.Contains("Áila", StringComparison.OrdinalIgnoreCase))
                {
                    npcImage = "/images/Friend_2.png";
                }
            }
            if (!string.IsNullOrEmpty(npcImage))
            {
                <div class="character-display">
                    <img src="@npcImage" alt="@Model.CurrentAct.Character.Name" loading="lazy" />
                </div>
            }
        }

        @* Player Character Sprite *@
        @if (Model.PlayerCharacter != null && !string.IsNullOrEmpty(Model.PlayerCharacter.ImageUrl))
        {
            <div class="player-character-display">
                <img src="@Model.PlayerCharacter.ImageUrl" alt="@Model.SelectedCharacterName" loading="lazy" />
            </div>
        }

        @* Dialogue Box - Split into NPC dialogue and Player choices *@
        <div class="dialogue-box">
            @* NPC Dialogue Section *@
            <div class="npc-dialogue">
                @if (Model.CurrentAct.Character != null)
                {
                    <div class="speaker-name">@Model.CurrentAct.Character.Name</div>
                }
                
                <div class="dialogue-text">@Model.CurrentAct.Content</div>
            </div>

            @* Player Choices Section *@
            @if (Model.HasChoices)
            {
                <div class="player-choices">
                    <div class="choices-label">Your Response:</div>
                    <form asp-action="Choose" asp-controller="Story" method="post">
                        @Html.AntiForgeryToken()
                        <input type="hidden" asp-for="CurrentStoryActId" />

                        <div class="choices-container">
                        @foreach (var choice in Model.Choices)
                        {
                            <button type="submit" 
                                    class="choice-button" 
                                    name="SelectedChoiceId" 
                                    value="@choice.Id">
                                @choice.Text
                            </button>
                        }
                        </div>
                    </form>
                </div>
            }
        </div>

        @if (!string.IsNullOrEmpty(Model.ErrorMessage))
        {
            <div class="alert alert-danger mt-3" style="position: fixed; top: 100px; left: 50%; transform: translateX(-50%); z-index: 999;">@Model.ErrorMessage</div>
        }
    </div>
</div>

<script src="~/lib/jquery/dist/jquery.min.js"></script>
<script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
