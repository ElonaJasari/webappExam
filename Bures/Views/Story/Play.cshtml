@model Bures.ViewModels.StoryPlayViewModel

@{
    ViewData["Title"] = Model.DisplayTitle;
    Layout = null;
}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"]</title>
    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="~/css/site.css" />
    <link rel="stylesheet" href="~/css/story.css" />
</head>
<body style="margin: 0; padding: 0; overflow: hidden;">

<div class="visual-novel-container">
    @* Preload current scene and character images to reduce perceived latency *@
    @if (!string.IsNullOrEmpty(Model.CurrentAct.ImageUrl))
    {
        <link rel="preload" as="image" href="@Model.CurrentAct.ImageUrl" />
    }
    @if (Model.CurrentAct.Character != null && !string.IsNullOrEmpty(Model.CurrentAct.Character.ImageUrl))
    {
        <link rel="preload" as="image" href="@Model.CurrentAct.Character.ImageUrl" />
    }
    @if (!string.IsNullOrEmpty(Model.CurrentAct.ImageUrl))
    {
        <div class="scene-background">
            <img src="@Model.CurrentAct.ImageUrl" alt="Scene" loading="eager" onerror="this.style.display='none';" />
        </div>
    }

    <div class="game-ui">
        @* Top Status Bar *@
        <div class="top-bar">
            <div>
                <strong>@Model.DisplayTitle</strong>
                @if (!string.IsNullOrEmpty(Model.SelectedCharacterName))
                {
                    <span class="ms-3">Playing as: @Model.SelectedCharacterName</span>
                }
            </div>
            <div>
                <span class="ms-3">Trust: @Model.Trust</span>
            </div>
        </div>

        @* If this is an iPad scene, hide normal story content and show only iPad *@
        @if (Model.ShouldShowVocabulary || Model.ShouldShowTest)
        {
            @* iPad Scene - Hide all normal story elements *@
            <div style="display: none;">
                @* Hidden story content *@
            </div>
        }
        else
        {
            @* Normal Story Scene - Show dialogue and characters *@
            @* NPC Character Sprite with fallback *@
            @if (Model.CurrentAct.Character != null)
            {
                var npcImage = Model.CurrentAct.Character.ImageUrl;
                if (string.IsNullOrEmpty(npcImage))
                {
                    // Fallbacks by known character names
                    var name = Model.CurrentAct.Character.Name ?? string.Empty;
                    if (name.Contains("Teach", StringComparison.OrdinalIgnoreCase))
                    {
                        npcImage = "/images/teacher.png";
                    }
                    else if (name.Contains("Mother", StringComparison.OrdinalIgnoreCase) || name.Contains("Parent", StringComparison.OrdinalIgnoreCase))
                    {
                        npcImage = "/images/mom_character.png";
                    }
                    else if (name.Contains("√Åilu", StringComparison.OrdinalIgnoreCase))
                    {
                        npcImage = "/images/Friend_1.png";
                    }
                    else if (name.Contains("√Åila", StringComparison.OrdinalIgnoreCase))
                    {
                        npcImage = "/images/Friend_2.png";
                    }
                }
                if (!string.IsNullOrEmpty(npcImage))
                {
                    <div class="character-display">
                        <img src="@npcImage" alt="@Model.CurrentAct.Character.Name" loading="lazy" />
                    </div>
                }
            }

            @* Player Character Sprite *@
            @if (Model.PlayerCharacter != null && !string.IsNullOrEmpty(Model.PlayerCharacter.ImageUrl))
            {
                <div class="player-character-display">
                    <img src="@Model.PlayerCharacter.ImageUrl" alt="@Model.SelectedCharacterName" loading="lazy" />
                </div>
            }

            @* Dialogue Box - Split into NPC dialogue and Player choices *@
            <div class="dialogue-box">
                @* NPC Dialogue Section *@
                <div class="npc-dialogue">
                    @if (Model.CurrentAct.Character != null)
                    {
                        <div class="speaker-name">@Model.CurrentAct.Character.Name</div>
                    }
                    
                    <div class="dialogue-text">@Model.CurrentAct.Content</div>
                </div>

                @* Player Choices Section *@
                @if (Model.HasChoices)
                {
                    <div class="player-choices">
                        <div class="choices-label">Your Response:</div>
                        <form asp-action="Choose" asp-controller="Story" method="post">
                            @Html.AntiForgeryToken()
                            <input type="hidden" asp-for="CurrentStoryActId" />

                            <div class="choices-container">
                            @foreach (var choice in Model.Choices)
                            {
                                <button type="submit" 
                                        class="choice-button" 
                                        name="SelectedChoiceId" 
                                        value="@choice.Id">
                                    @choice.Text
                                </button>
                            }
                            </div>
                        </form>
                    </div>
                }
            </div>
        }

        @if (!string.IsNullOrEmpty(Model.ErrorMessage))
        {
            <div class="alert alert-danger mt-3" style="position: fixed; top: 100px; left: 50%; transform: translateX(-50%); z-index: 999;">@Model.ErrorMessage</div>
        }
    </div>
    
    @* Vocabulary Scene - iPad as the main scene content (not overlay) *@
    @if (Model.ShouldShowVocabulary)
    {
        <div id="vocabularyScene" class="ipad-scene-container">
            <div class="ipad-modal">
                <div class="ipad-header">
                    <div class="ipad-notch"></div>
                    <h3>üì± Your iPad</h3>
                </div>
                <div class="ipad-content">
                    <p class="ipad-message">@Model.VocabularyMessage</p>
                    
                    @if (Model.VocabularyWords.Any())
                    {
                        <div class="vocabulary-section">
                            <h4>Words to Learn</h4>
                            <div class="vocabulary-grid">
                                @foreach (var word in Model.VocabularyWords)
                                {
                                    <div class="vocabulary-card">
                                        <div class="vocabulary-sami">@word.Text</div>
                                        <div class="vocabulary-translation">@word.Description</div>
                                    </div>
                                }
                            </div>
                        </div>
                    }
                    
                    @if (Model.VocabularySentences.Any())
                    {
                        <div class="vocabulary-section">
                            <h4>Sentences to Practice</h4>
                            <div class="vocabulary-list">
                                @foreach (var sentence in Model.VocabularySentences)
                                {
                                    <div class="vocabulary-card">
                                        <div class="vocabulary-sami">@sentence.Text</div>
                                        <div class="vocabulary-translation">@sentence.Description</div>
                                    </div>
                                }
                            </div>
                        </div>
                    }
                    
                    @* Continue button - advances to next scene *@
                    @if (Model.HasChoices && Model.Choices.Any())
                    {
                        <form asp-action="Choose" asp-controller="Story" method="post">
                            @Html.AntiForgeryToken()
                            <input type="hidden" asp-for="CurrentStoryActId" />
                            @* Use the first choice to continue to next scene *@
                            @{
                                var continueChoice = Model.Choices.First();
                            }
                            <button type="submit" 
                                    class="ipad-button" 
                                    name="SelectedChoiceId" 
                                    value="@continueChoice.Id">
                                Continue
                            </button>
                        </form>
                    }
                    else
                    {
                        @* Fallback: If no choices exist, we need to create a default route *@
                        <p class="text-muted">No navigation available. Please ensure this scene has choices configured.</p>
                    }
                </div>
            </div>
        </div>
    }
    
    @* Test Scene - iPad as the main scene content (not overlay) *@
    @if (Model.ShouldShowTest && Model.TestTasks.Any())
    {
        <div id="testScene" class="ipad-scene-container">
            <div class="ipad-modal ipad-modal-large">
                <div class="ipad-header">
                    <div class="ipad-notch"></div>
                    <h3>üì± Final Test</h3>
                </div>
                <div class="ipad-content">
                    <p class="ipad-message">Time for your final test! Translate the following words and sentences.</p>
                    
                    <form asp-action="SubmitStoryTest" asp-controller="Story" method="post" id="testForm">
                        @Html.AntiForgeryToken()
                        <input type="hidden" asp-for="CurrentStoryActId" />
                        
                        <div class="test-questions">
                            @foreach (var task in Model.TestTasks)
                            {
                                <div class="test-question">
                                    <label class="test-label">
                                        <strong>@task.Text</strong>
                                        <span class="test-hint">(@task.Description)</span>
                                    </label>
                                    <input type="text" 
                                           name="answers[@task.TaskId]" 
                                           class="test-input" 
                                           placeholder="Enter your answer..." 
                                           autocomplete="off" 
                                           required />
                                </div>
                            }
                        </div>
                        
                        <div class="test-actions">
                            <button type="submit" class="ipad-button ipad-button-primary">Submit Test</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    }
    
    @* Test Result Display *@
    @if (TempData["TestScore"] != null)
    {
        <div id="testResultModal" class="ipad-modal-overlay">
            <div class="ipad-modal">
                <div class="ipad-header">
                    <div class="ipad-notch"></div>
                    <h3>üì± Test Results</h3>
                    <button type="button" class="ipad-close" onclick="closeTestResultModal()">√ó</button>
                </div>
                <div class="ipad-content">
                    @{
                        var score = TempData["TestScore"] as double? ?? 0.0;
                        var correct = TempData["TestCorrect"] as int? ?? 0;
                        var total = TempData["TestTotal"] as int? ?? 0;
                        var trustChange = TempData["TrustChange"] as int? ?? 0;
                    }
                    <div class="test-result">
                        <h2 class="test-score">@score.ToString("F1")%</h2>
                        <p>You got <strong>@correct out of @total</strong> correct!</p>
                        @if (trustChange < 0)
                        {
                            <p class="trust-change negative">Trust: @trustChange</p>
                        }
                        else
                        {
                            <p class="trust-change positive">Trust: +@trustChange</p>
                        }
                    </div>
                    <button type="button" class="ipad-button" onclick="closeTestResultModal()">Continue</button>
                </div>
            </div>
        </div>
    }
</div>

<script src="~/lib/jquery/dist/jquery.min.js"></script>
<script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
<script>
    function closeVocabularyModal() {
        $('#vocabularyModal').fadeOut(300, function() {
            $(this).remove();
        });
    }
    
    function closeTestResultModal() {
        $('#testResultModal').fadeOut(300, function() {
            $(this).remove();
        });
    }
    
    // iPad scenes are always visible (they're the main scene content, not modals)
    // Test result modal still appears as overlay
    $(document).ready(function() {
        @if (TempData["TestScore"] != null)
        {
            <text>
            $('#testResultModal').show();
            </text>
        }
    });
</script>
</body>
</html>
